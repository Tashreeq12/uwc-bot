<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UWC Bot (Text + Voice)</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; }
    .bar { display:flex; gap:8px; align-items:center; padding:10px; border-bottom:1px solid #eee; }
    #voiceToggle { border:0; padding:10px 14px; border-radius:8px; cursor:pointer; background:#1e88e5; color:#fff; }
    #voiceToggle:disabled { background:#9e9e9e; }
    #status { font-size:14px; color:#555; flex:1; }
    #webchat { width:100%; height: calc(100vh - 56px); }
    /* Option 2: force-hide default Botpress mic buttons */
    .bpw-speech-button, .bpw-floating-button {
      display: none !important;
      visibility: hidden !important;
      pointer-events: none !important;
    }
  </style>
  <script src="https://cdn.botpress.cloud/webchat/v3.2/inject.js"></script>
</head>
<body>

<div class="bar">
  <button id="voiceToggle">🎤 Start Voice</button>
  <span id="status">You can type below or use voice 🎤</span>
</div>

<div id="webchat"></div>

<script>
  // Option 1: Initialize Botpress Webchat without default voice button
  window.botpress.init({
    botId: 'aa441515-3c65-48ea-acd1-91044111bed2',
    clientId: '4122d265-45f6-47ff-ad06-007367e5444b',
    selector: '#webchat',
    configuration: {
      enableTextInput: true,
      enableVoice: false,  // disables top-left voice button
      showConversationsButton: false,
      themeMode: 'light',
      fontFamily: 'Inter, Arial',
      radius: 4,
      headerVariant: 'glass',
      color: '#3276EA',
      footer: "[⚡ by Botpress](https://botpress.com/?from=webchat)"
    }
  });

  (function ready(cb){
    if(window.botpressWebChat){ cb(); } 
    else { setTimeout(() => ready(cb), 100); }
  })(function(){
    const statusEl = document.getElementById('status');
    const voiceToggle = document.getElementById('voiceToggle');

    // Function to speak text aloud
    function speak(text){
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'en-US';
      u.rate = 1.0;
      window.speechSynthesis.speak(u);
    }

    // Function to play short audio cues
    function playSound(type){
      const audio = new Audio();
      if(type === 'listening') audio.src = 'https://actions.google.com/sounds/v1/alarms/beep_short.ogg';
      else if(type === 'stopped') audio.src = 'https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg';
      else if(type === 'botSpeaking') audio.src = 'https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg';
      audio.play();
    }

    // Speak bot replies and play cue
    window.botpressWebChat.onEvent('incoming.message', (event)=>{
      if(event.payload && event.payload.text){
        playSound('botSpeaking');
        speak(event.payload.text);
      }
    });

    // Speech-to-Text setup
    const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!Rec){
      statusEl.textContent = 'Voice input not supported in this browser. Please use Chrome.';
      voiceToggle.disabled = true;
      return;
    }

    const rec = new Rec();
    rec.lang = 'en-US';
    rec.interimResults = false;

    let listening = false;

    voiceToggle.addEventListener('click', ()=>{
      if(!listening){
        rec.start();
        listening = true;
        voiceToggle.textContent = '⏹ Stop Voice';
        statusEl.textContent = 'Listening… (allow mic if asked)';
        playSound('listening');
      } else {
        rec.stop();
        listening = false;
        voiceToggle.textContent = '🎤 Start Voice';
        statusEl.textContent = 'You can type below or use voice 🎤';
        playSound('stopped');
      }
    });

    rec.onresult = (e)=>{
      const said = e.results[0][0].transcript;
      statusEl.textContent = `You said: ${said}`;
      
      // Send spoken text to bot
      window.botpressWebChat.sendEvent({
        type: 'input.text',
        text: said,
        payload: {},
        channel: 'web'
      });
    };

    rec.onerror = ()=>{
      statusEl.textContent = 'Mic error. Try again.';
      listening = false;
      voiceToggle.textContent = '🎤 Start Voice';
      playSound('stopped');
    };
    
    rec.onend = ()=>{
      if(listening){
        listening = false;
        voiceToggle.textContent = '🎤 Start Voice';
        statusEl.textContent = 'You can type below or use voice 🎤';
        playSound('stopped');
      }
    };
  });
</script>

</body>
</html>


